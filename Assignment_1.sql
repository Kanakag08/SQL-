--Kanak Agrawal Assignment 1 (28/11/2023)

--creating table  customer
CREATE DATABASE TechShop;

USE TechShop;

CREATE TABLE CUSTOMERS
(
CUSTOMERID INT PRIMARY KEY,
FIRSTNAME VARCHAR(50),
LASTNAME VARCHAR(50),
EMAIL VARCHAR(60),
PHONE VARCHAR(10),
CADDRESS VARCHAR(100)
);

SELECT * FROM CUSTOMERS
ALTER TABLE [dbo].[CUSTOMERS]
ALTER COLUMN PHONE VARCHAR(10)

ALTER TABLE CUSTOMERS 
ADD ORDERCOUNT INT


-- Inserting data into the Customers table
INSERT INTO CUSTOMERS(CUSTOMERID, FIRSTNAME, LASTNAME, EMAIL, PHONE, CADDRESS)
VALUES
(1, 'John', 'Doe', 'john.doe@email.com', '123-456-78', '123 Main St'),
(2, 'Jane', 'Smith', 'jane.smith@email.com', '987-654-32', '456 Oak St'),
(3, 'Robert', 'Johnson', 'robert.j@email.com', '555-123-47', '789 Pine St'),
(4, 'Amanda', 'Clark', 'amanda.c@email.com', '444-789-01', '101 Cedar Ave'),
(5, 'Michael', 'Brown', 'michael.b@email.com', '222-555-78', '202 Elm St'),
(6, 'Emily', 'Taylor', 'emily.t@email.com', '888-333-44', '303 Maple Ave');

INSERT INTO CUSTOMERS(CUSTOMERID, FIRSTNAME, LASTNAME, EMAIL, PHONE, CADDRESS)
VALUES
(7, 'kanak', 'Agrawal', 'kanakagr08@email.com', '89-012-22', '123 east coast'),
(8, 'Anushka','Chouskey','anushka@email.com','123-005-89', '456 bandra'),
(9, 'pari', 'saraf','paris@email.com', '003-783-20', '203 oak st'),
(10,'harsh','khadgi','harshkhadgi@email.com', '300-985-10', '210 mahal road');

--creating table Products

CREATE DATABASE TechShop;

USE TechShop;

CREATE TABLE PRODUCTS
(
PRODUCTID INT PRIMARY KEY,
PRODUCTNAME VARCHAR(50),
PDESCRIPTION VARCHAR,
PRICE INT
);

ALTER TABLE [dbo].[PRODUCTS]
ALTER COLUMN PDESCRIPTION VARCHAR(100)

SELECT * FROM PRODUCTS

INSERT INTO PRODUCTS (PRODUCTID, PRODUCTNAME, PDESCRIPTION, PRICE)
VALUES 
(1, 'Laptop', 'High-performance laptop', 999),
(2, 'Smartphone', 'Latest smartphone model', 499),
(3, 'Tablet', '10-inch tablet with touch screen', 299),
(4, 'Headphones', 'Wireless noise-canceling headphones', 129),
(5, 'Camera', 'Digital camera with HD recording', 449),
(6, 'Smartwatch', 'Fitness and health tracking smartwatch', 199);

INSERT INTO PRODUCTS (PRODUCTID, PRODUCTNAME, PDESCRIPTION, PRICE)
VALUES
(7,'Televison','Flat screen LCD TV',23000),
(8,'Speakers','wireless bluetooth speakers', 5000),
(9, 'cellphone','oneplus nord',26000),
(10,'charger','65 w fast charger',2000);

--creating table orders
CREATE TABLE ORDERS
(
ORDERID INT PRIMARY KEY,
CUSTOMERID INT FOREIGN KEY
REFERENCES CUSTOMERS(CUSTOMERID),
ORDERDATE DATE,
TOTALAMOUNT INT 
);


ALTER TABLE ORDERS
ADD OSTATUS VARCHAR(100);

ALTER TABLE ORDERS
ADD ORDERCOUNT INT;


SELECT * FROM ORDERS

INSERT INTO ORDERS (ORDERID, CUSTOMERID, ORDERDATE, TOTALAMOUNT)
VALUES
(101, 1, '2023-01-15', 1499),
(102, 2, '2023-02-20', 799),
(103, 3, '2023-03-10', 299),
(104, 4, '2023-04-05', 129);

INSERT INTO ORDERS (ORDERID, CUSTOMERID, ORDERDATE, TOTALAMOUNT)
VALUES
(105, 5, '2023-05-15', 1599),
(106, 6, '2023-06-20', 709),
(107, 7, '2023-07-10', 509),
(108, 8, '2023-08-05', 600),
(109, 9, '2023-01-10', 5109),
(110, 10, '2023-09-05', 6000);

--creating order details
CREATE TABLE ORDERSDETAILS
(
ORDERDETAILID INT PRIMARY KEY,
ORDERID INT FOREIGN KEY
REFERENCES ORDERS(ORDERID),
PRODUCTID INT FOREIGN KEY 
REFERENCES PRODUCTS(PRODUCTID),
QUANTITY INT 
);

ALTER TABLE ORDERSDETAILS
ADD PRICE INT 

SELECT * FROM ORDERSDETAILS

INSERT INTO ORDERSDETAILS (ORDERDETAILID, ORDERID, PRODUCTID, QUANTITY)
VALUES
(201, 101, 1, 2),
(202, 101, 2, 1),
(203, 102, 1, 1),
(204, 103, 3, 1),
(205, 104, 4, 1),
(206, 104, 5, 1);

INSERT INTO ORDERSDETAILS (ORDERDETAILID, ORDERID, PRODUCTID, QUANTITY)
VALUES
(207,105,7,3),
(208,105,6,2),
(209,104,2,5),
(210,106,3,1);


--creating table inventory
CREATE TABLE INVENTORY
(INVENTORYID INT, 
PRODUCTID INT FOREIGN KEY 
REFERENCES PRODUCTS(PRODUCTID),
QUANTITYINSTOCK INT,
LASTSTOCKUPDATE DATE
);

SELECT * FROM INVENTORY

INSERT INTO INVENTORY(INVENTORYID, PRODUCTID, QUANTITYINSTOCK, LASTSTOCKUPDATE)
VALUES
(301, 1, 5, '2023-01-10 '),
(302, 2, 10, '2023-02-18'),
(303, 3, 8, '2023-03-05 '),
(304, 4, 15, '2023-04-01'),
(305, 5, 6, '2023-04-05 '),
(306, 6, 12, '2023-04-05');

INSERT INTO INVENTORY(INVENTORYID, PRODUCTID, QUANTITYINSTOCK, LASTSTOCKUPDATE)
VALUES
(307, 7, 5, '2023-08-10 '),
(308, 8, 15, '2023-10-22'),
(309, 9, 12, '2023-03-05 '),
(310, 10, 17, '2023-09-11');


--DML 
--Q2 B
--1
USE TechShop;

SELECT FIRSTNAME,LASTNAME, EMAIL
FROM CUSTOMERS;

--2

SELECT ORDERS.ORDERID, ORDERS.ORDERDATE, CUSTOMERS.FIRSTNAME, CUSTOMERS.LASTNAME
FROM ORDERS
INNER JOIN CUSTOMERS ON ORDERS.CUSTOMERID = CUSTOMERS.CUSTOMERID;


--3
INSERT INTO CUSTOMERS(CUSTOMERID, FIRSTNAME, LASTNAME, EMAIL, CADDRESS)
VALUES (11, 'NewFirstName', 'NewLastName', 'new.email@example.com', 'NewAddress');

SELECT * FROM CUSTOMERS;

--4

UPDATE PRODUCTS 
SET PRICE= PRICE*1.1
WHERE PRODUCTNAME ='Laptop';

SELECT * FROM PRODUCTS;

--5
DELETE FROM ORDERS 
WHERE ORDERID = 3;

DELETE FROM ORDERSDETAILS
WHERE ORDERID= 3;



--6
INSERT INTO ORDERS (CUSTOMERID,ORDERID,ORDERDATE, TOTALAMOUNT)
VALUES (11, 111,'2023-11-28',200);

SELECT * FROM ORDERS

--7
DECLARE @CUSTOMERID INT = 1;  
DECLARE @ORDERID INT = 11;  
DECLARE @ORDERDATE DATE = '2023-11-28'; 


--8

UPDATE ORDERS 

SET TOTALAMOUNT =(
SELECT SUM(p.PRICE* od.QUANTITY)
FROM ORDERSDETAILS AS od 
INNER JOIN PRODUCTS AS p ON od.PRODUCTID=p.PRODUCTID 
WHERE od.ORDERID = ORDERS. ORDERID
);

SELECT * FROM ORDERS


--9 
DECLARE @CUSTOMERID INT;
SET @CUSTOMERID = 1; 

BEGIN TRANSACTION;
DELETE FROM ORDERSDETAILS
WHERE ORDERID IN (
    SELECT ORDERID
    FROM ORDERS
    WHERE CUSTOMERID = 1
);

-- Delete orders for the specified customer
DELETE FROM Orders
WHERE CustomerID = @CustomerID;

COMMIT;



--10 

INSERT INTO PRODUCTS (PRODUCTID,PRODUCTNAME, PDESCRIPTION, PRICE)
VALUES (11,'New Gadget', 'Electronics', 499);


--11

UPDATE ORDERS 
SET OSTATUS ='shipped'
WHERE ORDERID= 102;


SELECT * FROM ORDERS

--12

UPDATE CUSTOMERS
SET ORDERCOUNT = (
    SELECT COUNT(*)
    FROM ORDERS
    WHERE ORDERS.CUSTOMERID = CUSTOMERS.CUSTOMERID
);

SELECT * FROM CUSTOMERS


--4.1 

SELECT ORDERS.*,
CUSTOMERS.FIRSTNAME ,CUSTOMERS.LASTNAME 
FROM ORDERS
JOIN CUSTOMERS ON 
ORDERS.CUSTOMERID =CUSTOMERS.CUSTOMERID;
   

   --4.2

   SELECT 
   P.PRODUCTID,
   P.PRODUCTNAME,
   SUM(OD.QUANTITY * P.PRICE) AS TotalRevenue 
   FROM PRODUCTS AS P
   INNER JOIN ORDERSDETAILS AS OD ON P.PRODUCTID = OD.PRODUCTID
   INNER JOIN ORDERS AS O ON OD.ORDERID= O.ORDERID
   GROUP BY P.PRODUCTID, P.PRODUCTNAME;




--4.3

SELECT DISTINCT 
    CUSTOMERS.CUSTOMERID,
    CUSTOMERS.FIRSTNAME,
	CUSTOMERS.PHONE
	FROM CUSTOMERS
	JOIN ORDERS ON 
	CUSTOMERS.CUSTOMERID=ORDERS.CUSTOMERID;
   

   --4.4

   SELECT P.PRODUCTNAME, SUM(QUANTITY) AS Popular_Product
   FROM PRODUCTS AS P 
   INNER JOIN ORDERSDETAILS AS OD ON P.PRODUCTID=OD.PRODUCTID GROUP BY P.PRODUCTID,P.PRODUCTNAME
   ORDER BY Popular_Product DESC
   OFFSET 0 ROWS 
   FETCH NEXT 1 ROWS ONLY;

	--4.5

 SELECT
    P.PRODUCTNAME,
    SUM(OD.QUANTITY) AS TotalQuantityOrdered
FROM
    PRODUCTS P
JOIN
    ORDERSDETAILS OD ON P.PRODUCTID = OD.PRODUCTID
GROUP BY
    P.PRODUCTID, P.PRODUCTNAME
ORDER BY
    TotalQuantityOrdered DESC;
	

	--4.6


SELECT
    C.CUSTOMERID,
    C.FIRSTNAME,
    AVG(OD.QUANTITY * OD.PRICE) AS AverageOrderValue
FROM
   CUSTOMERS C
JOIN
    ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
JOIN
    ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID
GROUP BY
    C.CUSTOMERID, C.FIRSTNAME;


	--4.7

	SELECT TOP 1
    O.ORDERID,
    C.CUSTOMERID,
    C.FIRSTNAME,
    C.PHONE,
    SUM(OD.QUANTITY * OD.PRICE) AS TotalRevenue
FROM
    ORDERS O
JOIN
    CUSTOMERS C ON O.CUSTOMERID = C.CUSTOMERID
JOIN
    ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID
GROUP BY
    O.ORDERID, C.CUSTOMERID, C.FIRSTNAME, C.PHONE
ORDER BY
    TotalRevenue DESC;


	--4.8

	SELECT
    P.PRODUCTID,
    P.PRODUCTNAME,
    COUNT(OD.ORDERID) AS NumberOfOrders
FROM
    Products P
JOIN
    ORDERSDETAILS OD ON P.PRODUCTID = OD.PRODUCTID
GROUP BY
    P.PRODUCTID, P.PRODUCTNAME
ORDER BY
    NumberOfOrders DESC;

--4.9


DECLARE @PRODUCTNAME NVARCHAR(255);
SET @PRODUCTNAME = 'Television'; 


SELECT
    C.CUSTOMERID,
    C.FIRSTNAME,
    C.PHONE
FROM
   CUSTOMERS C
JOIN
    ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
JOIN
    ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID
JOIN
    PRODUCTS P ON OD.PRODUCTID = P.PRODUCTID
WHERE
    P.PRODUCTNAME = @PRODUCTNAME;


	--4.10

	DECLARE @StartDate DATE;
DECLARE @EndDate DATE;

SET @StartDate = '2023-01-15';
SET @EndDate = '2023-09-05'; 

SELECT
    SUM(OD.QUANTITY * OD.PRICE) AS TotalRevenue
FROM
    ORDERS O
JOIN
    ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID
WHERE
    O.ORDERDATE BETWEEN @StartDate AND @EndDate;





	--Aggregate functions and subquery 

	--5.1

	SELECT
    C.CUSTOMERID,
    C.FIRSTNAME,
    C.PHONE
FROM
    CUSTOMERS C
LEFT JOIN
   ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
WHERE
    O.ORDERID IS NULL;

	--5.2

	SELECT COUNT(*) AS TotalProducts
FROM PRODUCTS;

--5.3

SELECT
    SUM(OD.QUANTITY * OD.PRICE) AS TotalRevenue
FROM
    ORDERS O
JOIN
    ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID;


	--5.4

	DECLARE @PID INT;
SET @PID = 205;
select P.PRODUCTID,PRODUCTNAME, count(QUANTITY) as Total_quantity from PRODUCTS as P
inner join ORDERSDETAILS as od on p.PRODUCTID=od.PRODUCTID
where P.PRODUCTID = @PID 
group by P.PRODUCTID,P.PRODUCTNAME,QUANTITY;


	--5.5

	DECLARE @CUSTOMERID INT;
SET @CUSTOMERID = 123; 

SELECT
    SUM(OD.QUANTITY * OD.PRICE) AS TotalRevenue
FROM
    ORDERS O
JOIN
   ORDERSDETAILS OD ON O.OrderID = OD.ORDERID
WHERE
    O.CUSTOMERID = @CUSTOMERID;



	--5.6

	SELECT TOP 1
    C.CUSTOMERID,
    C.FIRSTNAME,
    COUNT(O.ORDERID) AS NumberOfOrders
FROM
    CUSTOMERS C
JOIN
    ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
GROUP BY
    C.CUSTOMERID, C.FIRSTNAME
ORDER BY
    NumberOfOrders DESC;



	--5.7
	SELECT P.PDESCRIPTION,SUM(OD.QUANTITY) AS TotalQuantityOrdered
	FROM PRODUCTS AS P
	INNER JOIN ORDERSDETAILS AS OD ON P.PRODUCTID=OD.PRODUCTID
	GROUP BY P.PDESCRIPTION 
	ORDER BY TotalQuantityOrdered DESC
	OFFSET 0 ROWS 
	FETCH NEXT 1 ROWS ONLY;
	


	--5.8
	SELECT TOP 1
    C.CUSTOMERID,
    C.FIRSTNAME,
    SUM(OD.QUANTITY * OD.PRICE) AS TotalSpending
FROM
    CUSTOMERS C
JOIN
    ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
JOIN
    ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID
JOIN
    PRODUCTS P ON OD.PRODUCTID= P.PRODUCTID
WHERE
    P.PRODUCTNAME = 'Laptop'
GROUP BY
    C.CUSTOMERID, C.FIRSTNAME
ORDER BY
    TotalSpending DESC;



	--5.9

	SELECT
    AVG(OrderRevenue) AS AverageOrderValue
FROM (
    SELECT
        O.ORDERID,
        SUM(OD.QUANTITY * OD.PRICE) AS OrderRevenue
    FROM
       ORDERS O
    JOIN
        ORDERSDETAILS OD ON O.ORDERID = OD.ORDERID
    GROUP BY
        O.ORDERID
) AS OrderRevenues;


--5.10
SELECT
    C.CUSTOMERID,
    C.FIRSTNAME,
    COUNT(O.ORDERID) AS OrderCount
FROM
    CUSTOMERS C
LEFT JOIN
    ORDERS O ON C.CUSTOMERID = O.CUSTOMERID
GROUP BY
    C.CUSTOMERID, C.FIRSTNAME
ORDER BY
    OrderCount DESC;
